FROM ubuntu:20.04

RUN apt-get update && \
    apt install -y build-essential autoconf automake bison libevent-dev libtool libz-dev zlib1g-dev wget netcat

COPY ./aliases ./

COPY ./smtpd.conf ./

RUN wget http://ftp.openbsd.org/pub/OpenBSD/LibreSSL/libressl-3.0.2.tar.gz && \
    tar -xzvf libressl-3.0.2.tar.gz && \
    cd libressl-3.0.2 && \
    chmod +x ./configure && \
    ./configure && \
    make && \
    make install && \
    ldconfig && \
    cd ..

RUN wget https://opensmtpd.org/archives/libasr-1.0.3.tar.gz && \
    tar -xzvf libasr-1.0.3.tar.gz && \
    cd libasr-1.0.3 && \
    chmod +x ./bootstrap && \
    chmod +x ./configure && \
    ./bootstrap && \
    ./configure && \
    make && \
    make install && \
    cd ..

RUN wget https://github.com/OpenSMTPD/OpenSMTPD/releases/download/6.6.1p1/opensmtpd-6.6.1p1.tar.gz && \
    tar -xzvf opensmtpd-6.6.1p1.tar.gz && \
    cd opensmtpd-6.6.1p1 && \
    chmod +x ./bootstrap && \
    chmod +x ./configure && \
    ./bootstrap && \
    ./configure && \
    make && \
    make install && \
    ldconfig && \
    cd ..

RUN mkdir /var/empty && \
    useradd -c "SMTP Daemon" -d /var/empty -s /sbin/nologin _smtpd && \
    useradd -c "SMTPD Queue" -d /var/empty -s /sbin/nologin _smtpq && \
    mkdir /etc/mail/ && \
    chmod +rwx /etc/mail/ && \
    mv -f ./aliases /etc/mail/aliases && \
    mv -f ./smtpd.conf /usr/local/etc/smtpd.conf

EXPOSE 25

CMD ["bash", "-c", "smtpd -dv"]